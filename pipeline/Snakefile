configfile: "config.yaml"
N =  range(1, config['N_Shuffled'])

rule all:
    input:
        expand("{GO}.txt", GO=config['GO'] ),     
        expand("{FP}_{RNA}.regression.log", FP = "SRR5090936", RNA = "SRR5090934"),
        expand("{FP}_{RNA}-{SUBSET}.regression.log", FP = "SRR5090936", RNA = "SRR5090934", SUBSET=config['GO']),
        expand("{FP}_{RNA}-{SUBSET}.regression.log", FP = "SRR5090936", RNA = "SRR5090934", SUBSET=config['GL']),
        expand("{FP}_{RNA}.regression.log", FP = "SRR5090937", RNA = "SRR5090935"),
        expand("{FP}_{RNA}-{SUBSET}.regression.log", FP = "SRR5090937", RNA = "SRR5090935", SUBSET=config['GO']),
        expand("{FP}_{RNA}-{SUBSET}.regression.log", FP = "SRR5090937", RNA = "SRR5090935", SUBSET=config['GL']),
        expand("{FP}_{RNA}.regression.log", FP = "SRR9670822", RNA = "SRR9670820"),
        expand("{FP}_{RNA}-{SUBSET}.regression.log", FP = "SRR9670822", RNA = "SRR9670820", SUBSET=config['GO']),
        expand("{FP}_{RNA}-{SUBSET}.regression.log", FP = "SRR9670822", RNA = "SRR9670820", SUBSET=config['GL']),
        expand("{FP}_{RNA}.regression.log", FP = "SRR9670823", RNA = "SRR9670821"),
        expand("{FP}_{RNA}-{SUBSET}.regression.log", FP = "SRR9670823", RNA = "SRR9670821", SUBSET=config['GO']),
        expand("{FP}_{RNA}-{SUBSET}.regression.log", FP = "SRR9670823", RNA = "SRR9670821", SUBSET=config['GL'])

rule ribofilio: 
    input:
         fp = "{SAMPLE1}.bed",
	 rna = "{SAMPLE2}.bed",
	 genome = config['GENOME'] 
    output: 
         "{SAMPLE1}_{SAMPLE2}.regression.log"
    params:
        prefix="{SAMPLE1}_{SAMPLE2}"
    shell:
        "python ../src/ribofilio.py -t {input.genome} -f {input.fp} -r {input.rna} -o {params.prefix} "

       
rule subset:
    input:
        fp = "{SAMPLE1}.bed",
        rna = "{SAMPLE2}.bed",
	subset = "{SUBSET}.txt",
        genome = config['GENOME']
    output:
        "{SAMPLE1}_{SAMPLE2}-{SUBSET}.regression.log"
    params:
        prefix="{SAMPLE1}_{SAMPLE2}-{SUBSET}"
    shell: 
        "python ../src/ribofilio.py -t {input.genome} -f {input.fp} -r {input.rna} -s {input.subset} -o {params.prefix}"


rule get_GO:
     output:
        expand("{GO}.txt", GO=config['GO'])
     params: 
        go = expand("{GO}", GO=config['GO'] )
     shell:
         """
         Rscript scripts/getGO.R {params.go}
         """

rule cluster: 
     output: 
        expand("{GL}.txt", GL=config['GL'])     
     shell: 
          """
          python scripts/gcluster.py yeast.fa yeast02000.txt --max 2000 --min 0
          python scripts/gcluster.py yeast.fa yeast20004000.txt --max 4000 --min 2000
          python scripts/gcluster.py yeast.fa yeast40006000.txt --max 6000 --min 4000
          python scripts/gcluster.py yeast.fa yeast6000100000.txt --max 100000 --min 6000
          """ 


rule index: 
     input: 
        genome = config['GENOME']
     output: 
        config['INDEX']
     shell: 
        "bowtie2-build {input.genome} {output} && touch {output}"

rule trim: 
    input:
        sample = "{SAMPLE}.fastq",
	index = config['INDEX']
    output:
        "galore/{SAMPLE}_trimmed.fq.gz", 
    params: 
       adapter =config['ADAPTERS']
    shell:
        """
        trim_galore --gzip --retain_unpaired --trim1 -a {params.adapter} --fastqc --fastqc_args "--outdir fastqc" -o galore {input.sample}   
        """ 

rule tobam:
      input:
          index  = config['INDEX'],
          sample = "galore/{READS}_trimmed.fq.gz"
      output:
          "{READS}.sam",
          "{READS}.bowtie2.bam"
      shell: 
          """ 
           bowtie2 -x {input.index} -U {input.sample} -S {output[0]}
           samtools view -S -b {output[0]} > {output[1]}
          """ 	

rule tobed: 
        input: 
             "{SAMPLE}.bowtie2.bam", 
             genome = config['GENOME'] 
        output: 
	     "{SAMPLE}.bed" 
	run: 
            """
            bedtools bamtobed -i {input} > {output}
            """


rule getGenome:
     output:
           config['GENOME']
     shell:
        """
        curl -O ftp://ftp.ensembl.org/pub/release-98/fasta/saccharomyces_cerevisiae/cdna/Saccharomyces_cerevisiae.R64-1-1.cdna.all.fa.gz
        gunzip Saccharomyces_cerevisiae.R64-1-1.cdna.all.fa.gz
        mv  Saccharomyces_cerevisiae.R64-1-1.cdna.all.fa {output}
        """
